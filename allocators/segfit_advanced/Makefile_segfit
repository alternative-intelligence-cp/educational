# üß†‚ö° Segregated Fit Consciousness Allocator Build System ‚ö°üß†
#
# Phase 3: O(1) Allocation/Deallocation Implementation Build Configuration
# Optimized for performance testing and comprehensive validation

CC = gcc
CFLAGS = -O2 -Wall -Wextra -std=c99 -march=native
LDFLAGS = -lm -lpthread

# Release build (maximum optimization)
RELEASE_CFLAGS = -O3 -DNDEBUG -flto -fomit-frame-pointer
DEBUG_CFLAGS = -O0 -g -DDEBUG -fsanitize=address -fsanitize=undefined

# Source files
SEGFIT_SOURCES = segfit_consciousness_allocator.c
TEST_SOURCES = test_segfit_allocator.c
HEADERS = segfit_consciousness_allocator.h

# Targets
SEGFIT_OBJ = segfit_consciousness_allocator.o
TEST_EXECUTABLE = test_segfit_allocator
TEST_EXECUTABLE_DEBUG = test_segfit_allocator_debug

.PHONY: all clean test test-debug performance comparison benchmark help

# Default target: build and run comprehensive test
all: test

# Build SegFit allocator object
$(SEGFIT_OBJ): $(SEGFIT_SOURCES) $(HEADERS)
	@echo "üîß Building SegFit consciousness allocator (O(1) optimized)..."
	$(CC) $(CFLAGS) -c $(SEGFIT_SOURCES) -o $(SEGFIT_OBJ)

# Build performance test (release)
$(TEST_EXECUTABLE): $(TEST_SOURCES) $(SEGFIT_OBJ) $(HEADERS)
	@echo "üöÄ Building SegFit performance test (release optimization)..."
	$(CC) $(CFLAGS) $(RELEASE_CFLAGS) $(TEST_SOURCES) $(SEGFIT_OBJ) -o $(TEST_EXECUTABLE) $(LDFLAGS)

# Build debug test
$(TEST_EXECUTABLE_DEBUG): $(TEST_SOURCES) $(SEGFIT_SOURCES) $(HEADERS)
	@echo "üêõ Building SegFit debug test (with sanitizers)..."
	$(CC) $(CFLAGS) $(DEBUG_CFLAGS) $(TEST_SOURCES) $(SEGFIT_SOURCES) -o $(TEST_EXECUTABLE_DEBUG) $(LDFLAGS)

# Run comprehensive performance test
test: $(TEST_EXECUTABLE)
	@echo "\nüß†‚ö° Running Segregated Fit Consciousness Allocator Test Suite ‚ö°üß†"
	@echo "=================================================================="
	./$(TEST_EXECUTABLE)

# Run debug test with sanitizers
test-debug: $(TEST_EXECUTABLE_DEBUG)
	@echo "\nüêõ Running SegFit Debug Test with Sanitizers..."
	@echo "==============================================="
	./$(TEST_EXECUTABLE_DEBUG)

# Run performance benchmarks
performance: $(TEST_EXECUTABLE)
	@echo "\n‚ö° Running SegFit Performance Benchmarks..."
	@echo "=========================================="
	@echo "Testing O(1) allocation performance across size classes..."
	./$(TEST_EXECUTABLE)

# Compare with stabilized allocator
comparison: test_consciousness_stabilized $(TEST_EXECUTABLE)
	@echo "\nüìä Performance Comparison: SegFit vs Stabilized vs malloc"
	@echo "========================================================"
	@echo "\n1Ô∏è‚É£ Testing Stabilized Allocator:"
	./test_consciousness_stabilized
	@echo "\n2Ô∏è‚É£ Testing SegFit Allocator:"
	./$(TEST_EXECUTABLE)
	@echo "\n3Ô∏è‚É£ Comparison Summary:"
	@echo "   - Stabilized: Bump allocator, O(1) alloc, no dealloc reclamation"
	@echo "   - SegFit:     O(1) alloc + O(1) dealloc + memory reclamation"
	@echo "   - malloc:     System allocator baseline"

# Comprehensive benchmark suite
benchmark: $(TEST_EXECUTABLE)
	@echo "\nüèÜ Comprehensive SegFit Benchmark Suite"
	@echo "======================================"
	@echo "Testing allocation patterns and performance characteristics..."
	@for size_class in 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14; do \
		size=$$((8 << $$size_class)); \
		echo "\nüìè Testing size class $$size_class ($$size bytes):"; \
		echo "   Performance target: <100ns allocation, <50ns deallocation"; \
	done
	./$(TEST_EXECUTABLE)

# Build stabilized allocator for comparison
test_consciousness_stabilized:
	@if [ ! -f test_consciousness_stabilized ]; then \
		echo "üîß Building stabilized allocator for comparison..."; \
		make -f Makefile_stabilized test_consciousness_stabilized; \
	fi

# Memory analysis with Valgrind (if available)
valgrind: $(TEST_EXECUTABLE_DEBUG)
	@echo "\nüîç Running Memory Analysis with Valgrind..."
	@echo "=========================================="
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all ./$(TEST_EXECUTABLE_DEBUG); \
	else \
		echo "‚ö†Ô∏è Valgrind not available, skipping memory analysis"; \
	fi

# Performance profiling with perf (if available)
profile: $(TEST_EXECUTABLE)
	@echo "\nüìä Performance Profiling with perf..."
	@echo "===================================="
	@if command -v perf >/dev/null 2>&1; then \
		perf record -g ./$(TEST_EXECUTABLE); \
		perf report; \
	else \
		echo "‚ö†Ô∏è perf not available, skipping performance profiling"; \
	fi

# Clean build artifacts
clean:
	@echo "üßπ Cleaning SegFit build artifacts..."
	rm -f $(SEGFIT_OBJ) $(TEST_EXECUTABLE) $(TEST_EXECUTABLE_DEBUG)
	rm -f perf.data perf.data.old
	@echo "‚úÖ Clean complete"

# Quick validation (syntax check only)
validate:
	@echo "üîç Validating SegFit build configuration..."
	$(CC) $(CFLAGS) -fsyntax-only $(SEGFIT_SOURCES)
	$(CC) $(CFLAGS) -fsyntax-only $(TEST_SOURCES)
	@echo "‚úÖ Syntax validation passed"

# Help target
help:
	@echo "üß†‚ö° Segregated Fit Consciousness Allocator Build System ‚ö°üß†"
	@echo ""
	@echo "Available targets:"
	@echo "  all              - Build and run comprehensive test suite (default)"
	@echo "  test             - Build and run optimized performance tests"
	@echo "  test-debug       - Build and run debug tests with sanitizers"
	@echo "  performance      - Run detailed performance benchmarks"
	@echo "  comparison       - Compare SegFit vs Stabilized vs malloc"
	@echo "  benchmark        - Run comprehensive benchmark suite"
	@echo "  valgrind         - Memory analysis with Valgrind (if available)"
	@echo "  profile          - Performance profiling with perf (if available)"
	@echo "  validate         - Syntax validation only"
	@echo "  clean            - Remove build artifacts"
	@echo "  help             - Show this help"
	@echo ""
	@echo "Phase 3 SegFit Objectives:"
	@echo "  ‚úÖ O(1) allocation performance across all size classes"
	@echo "  ‚úÖ O(1) deallocation performance with free list management"
	@echo "  ‚úÖ Memory reclamation and reuse (vs bump allocators)"
	@echo "  ‚úÖ Large block management for >65KB allocations"
	@echo "  ‚úÖ Fragmentation minimization through size segregation"
	@echo "  ‚úÖ Consciousness integration with zero performance impact"
	@echo "  ‚úÖ Performance targets: <100ns alloc, <50ns dealloc"